#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices , sampleTimes, dataIndices, measurementMapIndices,strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strains <- unique(antigenicMap$inf_years)
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains))
nStrains <- length(strains)
pars["mu"] <- 2
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
match(strainIsolationTimes1, strains)-1,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
#dat1$titre <- floor(dat1$titre)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices , sampleTimes, dataIndices, measurementMapIndices,strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
#liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
dataIndices
infectionHistory
strains
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains))
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 2
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
match(strainIsolationTimes1, strains)-1,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
#dat1$titre <- floor(dat1$titre)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices , sampleTimes, dataIndices, measurementMapIndices,strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
#liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices , sampleTimes, dataIndices, measurementMapIndices,strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
match(strainIsolationTimes1, strains)-1,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices , sampleTimes, dataIndices, measurementMapIndices,strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 2
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
match(strainIsolationTimes1, strains)-1,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices , sampleTimes, dataIndices, measurementMapIndices,strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 2
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
match(strainIsolationTimes1, strains)-1,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices,
sampleTimes, dataIndices, measurementMapIndices,
strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 2
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
match(strainIsolationTimes1, strains)-1,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]-1
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices,
sampleTimes, dataIndices, measurementMapIndices,
strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
conciseInfTimes
infectionMapIndices
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
infectionMapIndices
dataIndices
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 2
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
measurementMapIndices,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
infDat <- data.frame(x=strains[which(infectionHistory==1)])
sampDat <- data.frame(x=sampleTimes)
ggplot()+ #geom_line(data=dat, aes(x=virus,y=titre),col="red")+
geom_point(data=dat1,aes(x=virus,y=titre),col="blue") +
geom_vline(data=infDat,aes(xintercept=x)) +
geom_vline(data=sampDat,aes(xintercept=x),col="red")+
facet_wrap(~sample,ncol=1)
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=10)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 3
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
measurementMapIndices,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
infDat <- data.frame(x=strains[which(infectionHistory==1)])
sampDat <- data.frame(x=sampleTimes)
ggplot()+ #geom_line(data=dat, aes(x=virus,y=titre),col="red")+
geom_point(data=dat1,aes(x=virus,y=titre),col="blue") +
geom_vline(data=infDat,aes(xintercept=x)) +
geom_vline(data=sampDat,aes(xintercept=x),col="red")+
facet_wrap(~sample,ncol=1)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices,
sampleTimes, dataIndices, measurementMapIndices,
strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)
infectionHistory <- rep(0,numberStrains)
infectionHistory[which(strains==1968*12)] <- 1
infectionHistory[which(strains==1990*12)] <- 1
infectionHistory[which(strains==2009*12)] <- 1
strains <- unique(antigenicMap$inf_years)
sampleTimes <- seq(1970,2010,by=5)*12
dataIndices <- rep(length(strains),length(sampleTimes))
strainIsolationTimes1 <- as.numeric(rep(strains, length(sampleTimes)))
infectionHistory <- as.integer(infectionHistory)
strains <- as.numeric(strains)
circulationTimeIndices <- seq_along(strains)-1
circulationTimeIndices <- as.integer(circulationTimeIndices)
sampleTimes <- as.numeric(sampleTimes)
dataIndices <- as.integer(dataIndices)
measurementMapIndices <- as.numeric(match(strainIsolationTimes1,strains)-1)
nStrains <- length(strains)
pars["mu"] <- 3
pars["mu_short"]  <- 2
dat1 <- simulate_individual(pars, infectionHistory,sampleTimes,
dataIndices,strainIsolationTimes1,
measurementMapIndices,
antigenicMapLong,antigenicMapShort,strains)
dat1 <- as.data.frame(dat1)
colnames(dat1) <- c("sample","virus","titre")
dat1$titre <- floor(dat1$titre)
infDat <- data.frame(x=strains[which(infectionHistory==1)])
sampDat <- data.frame(x=sampleTimes)
ggplot()+ #geom_line(data=dat, aes(x=virus,y=titre),col="red")+
geom_point(data=dat1,aes(x=virus,y=titre),col="blue") +
geom_vline(data=infDat,aes(xintercept=x)) +
geom_vline(data=sampDat,aes(xintercept=x),col="red")+
facet_wrap(~sample,ncol=1)
r_likelihood <- function(expected, data, theta){
largeI <- data > theta["MAX_TITRE"]
smallI <- data <= 0
restI <- data > 0 & data <= theta["MAX_TITRE"]
large <- pnorm(theta["MAX_TITRE"], expected[largeI],theta["error"],0,1)
small <- pnorm(1, expected[smallI],theta["error"],1,1)
rest <- log(pnorm(data[restI]+1,expected[restI],theta["error"], 1, 0) - pnorm(data[restI],expected[restI], theta["error"],1, 0))
return(sum(large, small, rest))
}
conciseInfHist <- infectionHistory[infectionHistory > 0]
conciseInfTimes <- strains[which(infectionHistory > 0)]
infectionMapIndices <- circulationTimeIndices[which(infectionHistory > 0)]
#samplingTime <- 2011*12
#pars["wane"] <- 0.03
#dat <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
liks <- NULL
system.time(
for(i in 1:1000){
pars["mu"] <- (i-1)/100
#y <- infection_model_indiv(pars, conciseInfHist,conciseInfTimes,infectionMapIndices,samplingTime,match(strains,strains)-1,antigenicMapLong,antigenicMapShort,nStrains)
titres <- titre_data_individual(pars, infectionHistory, strains,circulationTimeIndices,
sampleTimes, dataIndices, measurementMapIndices,
strainIsolationTimes1,
antigenicMapLong,antigenicMapShort,nStrains)
liks[i] <- r_likelihood(titres,dat1$titre,pars)
#liks[i] <- likelihood_titre(titres, dat1$titre, pars)
#liks[i] <- sum(dnorm(x=dat1$titre, mean=titres, sd=1,log=TRUE))
}
)
plot(liks)
which.max(liks)

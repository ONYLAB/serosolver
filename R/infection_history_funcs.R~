# - - - - - - - - - - - - - - - -
# Set arbitrary initial condition for infection history - aim is to ensure likelihood is valid

setuphistIC<-function(ii,jj,inf.n,test.list,testyear_index, test_years, inf_years){ # ii=participant | jj=test year
  
  test.II=test.list[[ii]]
  test.jj=test.II[[jj]]
  
  spyear=unique(as.numeric(test.jj[3,])) # year of samples taken
  
  hist0=rep(0,inf.n)   
  #hist0[sample(c(1:inf.n),round(0.1*inf.n))]=1
  
  # Check test data available - may be issue if age column added too
  if(length(test.jj[,1])>1){
    
    # Set up test strains
    titredat=as.numeric(test.jj[2,]) # Define titre data
    
    # Use simple cutoff for titres -- set high titres = 1 in history if >=4
    for(i in 1:length(spyear)){
      if(max(titredat[(as.numeric(test.jj[3,])==spyear[i])])>=4 & runif(1)>0.2 ){
        hist0[(inf_years==spyear[i])]=1
      }
    }

  }
  
  min.range = max(1,testyear_index[1]-10) # Add an infection within past 10 years (useful for initial sampling)
  inf_index = inf_years-min(inf_years)+1
  inf_pick = sample(c(1:inf.n)[inf_index>=min.range & inf_index<= testyear_index[1]],1)  # pick strain within plausible region to add
  if(sum(hist0[inf_years < min(test_years)])==0){hist0[inf_pick]=1} # Make sure at least one infection occurs before earliest test year
  hist0
  
}








SampleHistory<-function(historyA,pick,inf.n,inf_years,age.mask){

  for(ii in pick){ # Resample subset of individuals
    
    rand1=runif(1)
    x=historyA[ii,age.mask[ii]:inf.n] # Only resample years individual was alive
    
    infvector=c(1:length(x))
    infvector2=rev(infvector)
    
    # Remove infection
    if(rand1<1/3){
      infectID=infvector[(as.numeric(x)>0)]
      if(length(infectID)>0){
        x[sample(c(infectID),1)]=0 # Why double? DEBUG
      }
    }
    
    # Add infection
    if(rand1>1/3 & rand1<2/3){
      ninfecID=infvector[(as.numeric(x)==0)]
      if(length(ninfecID)>0){
        x[sample(c(ninfecID),1)]=1
      }
    }
    
    # Move infection position
    if(rand1>2/3){
      infectID=infvector[(as.numeric(x)>0)]
      ninfecID=infvector[(as.numeric(x)==0)]
      
      if(length(infectID)>0 & length(ninfecID)>0){
        x[sample(c(infectID),1)]=0
        x[sample(c(ninfecID),1)]=1
      }
    }

    historyA[ii,age.mask[ii]:inf.n]=x # Only =1 if individual was alive
    
  } # end loop over individuals
  
  historyA
  
}

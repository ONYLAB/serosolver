<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serosolver: paper case study 1 • serosolver</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Serosolver: paper case study 1">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">serosolver</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cs1_vignette.html">Serosolver: paper case study 1</a>
    </li>
    <li>
      <a href="../articles/cs2_vignette.html">Serosolver: paper case study 2</a>
    </li>
    <li>
      <a href="../articles/serosolver-quick_start_guide.html">Serosolver: Quick Start Guide</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/seroanalytics/serosolver">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Serosolver: paper case study 1</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/seroanalytics/serosolver/blob/master/vignettes/cs1_vignette.Rmd"><code>vignettes/cs1_vignette.Rmd</code></a></small>
      <div class="hidden name"><code>cs1_vignette.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>This vignette provides all of the analyses for case study 1 in the accompanying package and paper. Briefly, the first case study aims to 1) reconstruct the unobserved infection dynamics from measured titres collected several months apart, 2) examine these infection dynamics stratified by available demographic variables, such as vaccination status and age, and 3) estimate biological parameters shaping the short-term antibody response.All of the functions used here are well documented and have many tunable arguments, and we therefore encourage users to refer to the helps files.</p>
</div>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<div id="installation-and-requirements" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-and-requirements" class="anchor"></a>Installation and requirements</h2>
<p><code>serosolver</code> may be installed from github using the <code>devtools</code> package. There are a number of additional packages that we need for this analysis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Required to run serosolver</span>
<span class="co">#devtools::install_github("seroanalytics/serosolver")</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(serosolver)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(plyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(data.table)

## Required for this analysis
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(reshape2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(foreach)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(doParallel)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(bayesplot)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(coda)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(viridis)

<span class="co"># set up cluster</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1234</span>)
cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">5</span>)

## Note that this vignette was generated on a Windows machine,
## and the setup for parallelisation is different on a Linux or Mac:

<span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.info">Sys.info</a></span>()[[<span class="st">"sysname"</span>]]<span class="op">==</span><span class="st">"Darwin"</span> <span class="op">|</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.info">Sys.info</a></span>()[[<span class="st">"sysname"</span>]]<span class="op">==</span><span class="st">"Linux"</span>){
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(doMC)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(doRNG)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/doMC/topics/registerDoMC">registerDoMC</a></span>(<span class="dt">cores=</span><span class="dv">5</span>)
}<span class="cf">else</span>{
  <span class="kw"><a href="https://www.rdocumentation.org/packages/doParallel/topics/registerDoParallel">registerDoParallel</a></span>(cl)
}</code></pre></div>
</div>
<div id="assumptions" class="section level2">
<h2 class="hasAnchor">
<a href="#assumptions" class="anchor"></a>Assumptions</h2>
<p>In this analysis, serological samples were taken between 2009 and 2011 and therefore all time variables are relative to this time period. We are interested in inferring infections and attack rates at a quarterly resolution, and therefore set <code>resolution</code> to 4. Our primary outcome of interest is to infer unbiased attack rates, and we therefore use the version of the code with a Beta prior on per-time attack rates, <code>prior_version=2</code>. We set these parameters at the start of the analysis. Additionally, we assume that the samples are tested against the same virus, therefore, we set all antigenic coordinates (more information below) to those of the first time point.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">filename &lt;-<span class="st"> "case_study_1"</span>
resolution &lt;-<span class="st"> </span><span class="dv">4</span> ## set to 4 for quarterly resolution
sample_years &lt;-<span class="st"> </span><span class="dv">2009</span><span class="op">:</span><span class="dv">2012</span>

serosolver<span class="op">::</span><span class="kw">describe_proposals</span>()
<span class="co">#&gt; Which version to use in run_MCMC? The following text describes the proposal step for updating infection histories.</span>
<span class="co">#&gt; Version 1: Beta prior on per time attack rates. Explicit FOI on each epoch using probability of infection term. Proposal performs N `flip` proposals at random locations in an individual's infection history, switching 1-&gt;0 or 0-&gt;1. Otherwise, swaps the contents of two random locations</span>
<span class="co">#&gt; Version 2: Beta prior on per time attack rates. Gibbs sampling of infection histories as in Indian Buffet Process papers, integrating out each probability of infection term.</span>
<span class="co">#&gt; Version 3: Beta prior on probability of infection for an individual, assuming independence between individuals. Samples from a beta binomial with alpha and beta specified by the par_tab input. Proposes nInfs moves at a time for add/remove, or when swapping, swaps locations up to moveSize time steps away</span>
<span class="co">#&gt; Version 4: Beta prior on probability of any infection. Gibbs sampling of infection histories using total number of infections across all times and all individuals as the prior</span>
prior_version &lt;-<span class="st"> </span><span class="dv">2</span></code></pre></div>
</div>
<div id="preparing-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-the-data" class="anchor"></a>Preparing the data</h2>
<p>The data used in this analysis are haemagglutination inhibition (HI) titres against A/H1N1pdm09 that began circulating in 2009. The raw data have been pre-processed to both convert them into a form usable for <code>serosolver</code> and to separate the data into vaccinated and unvaccinated data sets. Details about the pre-processing can be found in the scripts folder of the <code>serosolver</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Read in titre data
<span class="co"># unvaccinated</span>
input_dat_path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"HKdata_h1n1_unvac.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)
input_dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/read.table">read.csv</a></span>(<span class="dt">file =</span> input_dat_path, <span class="dt">header =</span> <span class="ot">TRUE</span>)
<span class="co"># vaccinated</span>
<span class="co"># input_dat_path2 &lt;- system.file("extdata", "HKdata_h1n1_vac.csv", package = "serosolver")</span>
<span class="co"># input_dat_vac &lt;- read.csv(file = input_dat_path2, header = TRUE)</span>

indivs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(input_dat<span class="op">$</span>individual) <span class="co">#all individuals</span>

<span class="co"># Subset data for indivs</span>
titre_dat &lt;-<span class="st"> </span>input_dat[input_dat<span class="op">$</span>individual <span class="op">%in%</span><span class="st"> </span>indivs,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"individual"</span>,<span class="st">"virus"</span>,<span class="st">"titre"</span>,<span class="st">"samples"</span>,<span class="st">"DOB"</span>)]
titre_dat<span class="op">$</span>individual &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/match">match</a></span>(titre_dat<span class="op">$</span>individual, indivs)

titre_dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(titre_dat)
titre_dat &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/plyr/topics/ddply">ddply</a></span>(titre_dat,.(individual,virus,samples),<span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(x,<span class="st">"run"</span>=<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(x),<span class="st">"group"</span>=<span class="dv">1</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(titre_dat))
<span class="co">#&gt;   individual virus titre samples  DOB run group</span>
<span class="co">#&gt; 1          1  8037     0    8039 8036   1     1</span>
<span class="co">#&gt; 2          1  8037     0    8040 8036   1     1</span>
<span class="co">#&gt; 3          1  8037     7    8044 8036   1     1</span>
<span class="co">#&gt; 4          1  8037     7    8047 8036   1     1</span>
<span class="co">#&gt; 5          2  8037     0    8039 8036   1     1</span>
<span class="co">#&gt; 6          2  8037     5    8041 8036   1     1</span></code></pre></div>
<p>NOTE: vaccinated and unvaccinated data must be run separately.</p>
<p>Given that this analysis uses titres from a single virus it is necessary to define an antigenic map with matching antigenic distance for each time point. We use coordinates based on the antigenic map created by Fonville et al. Generating the antigenic map involves fitting a smoothing spline through provided coordinates to give a representative virus for each time point (in this case, each quarter) that an individual could be infected. This process also inputs antigenic coordinates for time points that we do not have a measured virus. We then overwrite the coordinates at every time point with those of the first time point.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Read in raw coordinates
antigenic_coords_path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"fonville_map_approx.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)
antigenic_coords &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/read.table">read.csv</a></span>(antigenic_coords_path, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)

## Convert to form expected by serosolver
antigenic_map &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_antigenic_map.html">generate_antigenic_map</a></span>(antigenic_coords, resolution)

## Restrict entries to years of interest. Entries in antigenic_map determine
## the times that individual can be infected ie. the dimensions of the infection
## history matrix.
antigenic_map &lt;-<span class="st"> </span>antigenic_map[antigenic_map<span class="op">$</span>inf_years<span class="op">&gt;=</span>(sample_years[<span class="dv">1</span>]<span class="op">*</span>resolution<span class="op">+</span><span class="dv">1</span>) <span class="op">&amp;</span><span class="st"> </span>antigenic_map<span class="op">$</span>inf_years<span class="op">&lt;=</span>sample_years[<span class="dv">4</span>]<span class="op">*</span>resolution,]

## Change all coordinates to the same as the first pair of coordinates (because we assume the virus is the same at every time point)
antigenic_map[<span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(antigenic_map),<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'x_coord'</span>,<span class="st">'y_coord'</span>)] &lt;-<span class="st"> </span>antigenic_map[<span class="dv">1</span>,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'x_coord'</span>,<span class="st">'y_coord'</span>)]
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(antigenic_map))
<span class="co">#&gt;      x_coord  y_coord inf_years</span>
<span class="co">#&gt; 166 37.69244 8.233511      8037</span>
<span class="co">#&gt; 167 37.69244 8.233511      8038</span>
<span class="co">#&gt; 168 37.69244 8.233511      8039</span>
<span class="co">#&gt; 169 37.69244 8.233511      8040</span>
<span class="co">#&gt; 170 37.69244 8.233511      8041</span>
<span class="co">#&gt; 171 37.69244 8.233511      8042</span>

strain_isolation_times &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(antigenic_map<span class="op">$</span>inf_years)</code></pre></div>
<p>NOTE: <code>generate_antigenic_map</code> expects the provided file <code>fonville_map_approx.csv</code>. Users should refer to <code>generate_antigenic_map_flexible</code> for more generic antigenic map generation.</p>
<p>Finally, we must specify the <code>par_tab</code> data frame, which controls which parameters are included in the model, which are fixed, and their uniform prior ranges. Given that we are integrating out the probability of infection terms under prior version 2, we must remove these parameters from <code>par_tab</code>. Furthermore, given that we are interested in short-term dynamics with relatively sparse data, we remove parameters relating to the long-term antibody kinetics phase to avoid identifiability issues. We set alpha and beta to 1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">par_tab_path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"par_tab_base.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)
par_tab &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/read.table">read.csv</a></span>(par_tab_path, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)

## Set parameters for beta and alpha to 1
par_tab[par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>),<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">1</span>)
## Maximum recordable log titre in these data is 9
par_tab[par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "MAX_TITRE"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">9</span>

## Remove phi parameters, as these are integrated out under prior version 2
par_tab &lt;-<span class="st"> </span>par_tab[par_tab<span class="op">$</span>names <span class="op">!=</span><span class="st"> "phi"</span>,]

## Fix all long term parameters to 0
par_tab[par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>,<span class="st">"tau"</span>,<span class="st">"sigma1"</span>,<span class="st">"sigma2"</span>),<span class="st">"fixed"</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co">#mu, tau, sigma1, and sigma2 are fixed</span>
par_tab[par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>,<span class="st">"tau"</span>,<span class="st">"sigma1"</span>,<span class="st">"sigma2"</span>),<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">0</span> <span class="co"># set these values to 0</span></code></pre></div>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<ul>
<li>Choose resolution, attack rate priors and reference time for “the present”</li>
<li>Read in titre data and convert into a useable form for <code>serosolver</code>
</li>
<li>Generate antigenic map for the exposing virus</li>
<li>Generate parameter control table for MCMC</li>
</ul>
</div>
</div>
<div id="running-the-mcmc" class="section level1">
<h1 class="hasAnchor">
<a href="#running-the-mcmc" class="anchor"></a>Running the MCMC</h1>
<p>We are now ready to fit our model. We will fit multiple chains in parallel, though the below analysis could easily be replicated by running chains sequentially. Starting conditions for the MCMC chain must be generated that return a finite likelihood. The user may modify many of the MCMC control parameters, though the defaults are fine for most purposes.</p>
<p>Changing the number of iterations and the length of the adaptive period are often desirable. More crucially, the amount of chain thinning should be specified to ensure that users are not saving a large number of MCMC iterations (as this will rapidly fill disk space!). Thinning should be set such that at least 1000 iterations are saved (i.e., <code>iterations</code>/<code>thin</code> and <code>thin_hist</code>). Users are encouraged to pay extra attention to <code>thin_hist</code>, which dictates the thinning of the infection history chain, and can generate a very large file if left unchecked.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Distinct filename for each chain
no_chains &lt;-<span class="st"> </span><span class="dv">5</span>
filenames &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(filename, <span class="st">"_"</span>,<span class="dv">1</span><span class="op">:</span>no_chains)
chain_path &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"par_tab_base.csv"</span>,<span class="st">""</span>,par_tab_path)
chain_path_real &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chain_path, <span class="st">"cs1_real/"</span>)
chain_path_sim &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chain_path, <span class="st">"cs1_sim/"</span>)

## Create the posterior solving function that will be used in the MCMC framework 
par_tab[par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "mu_short"</span>,<span class="st">"lower_bound"</span>] &lt;-<span class="st"> </span><span class="dv">1</span>
model_func &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_posterior_func.html">create_posterior_func</a></span>(<span class="dt">par_tab=</span>par_tab,
                            <span class="dt">titre_dat=</span>titre_dat,
                            <span class="dt">antigenic_map=</span>antigenic_map,
                            <span class="dt">version=</span>prior_version) <span class="co"># function in posteriors.R</span>
<span class="co">#&gt; Creating posterior solving function...</span>
<span class="co">#&gt; </span>
  
## Generate results in parallel
res &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/foreach/topics/foreach">foreach</a></span>(<span class="dt">x =</span> filenames, <span class="dt">.packages =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'serosolver'</span>,<span class="st">'data.table'</span>,<span class="st">'plyr'</span>)) <span class="op">%dopar%</span><span class="st"> </span>{
  ## Not all random starting conditions return finite likelihood, so for each chain generate random
  ## conditions until we get one with a finite likelihood
  start_prob &lt;-<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span>
  <span class="cf">while</span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/is.finite">is.finite</a></span>(start_prob)){
    ## Generating starting antibody kinetics parameters
    start_tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_start_tab.html">generate_start_tab</a></span>(par_tab)
    
    ## Generate starting infection history
    start_inf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/setup_infection_histories_new_2.html">setup_infection_histories_new_2</a></span>(titre_dat, strain_isolation_times, <span class="dt">space=</span><span class="dv">3</span>,<span class="dt">titre_cutoff=</span><span class="dv">4</span>)
    start_prob &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw">model_func</span>(start_tab<span class="op">$</span>values, start_inf)[[<span class="dv">1</span>]])
  }
  
  res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_MCMC.html">run_MCMC</a></span>(<span class="dt">par_tab =</span> start_tab, 
                  <span class="dt">titre_dat =</span> titre_dat,
                  <span class="dt">antigenic_map =</span> antigenic_map,
                  <span class="dt">start_inf_hist =</span> start_inf, 
                  <span class="dt">mcmc_pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"iterations"</span>=<span class="dv">500000</span>,<span class="st">"adaptive_period"</span>=<span class="dv">100000</span>,
                                <span class="st">"thin"</span>=<span class="dv">1000</span>,<span class="st">"thin_hist"</span>=<span class="dv">1000</span>,
                                <span class="st">"save_block"</span>=<span class="dv">1000</span>,<span class="st">"inf_propn"</span>=<span class="dv">1</span>, 
                                <span class="st">"hist_sample_prob"</span>=<span class="dv">1</span>,<span class="st">"hist_switch_prob"</span>=<span class="fl">0.8</span>,
                                <span class="st">"year_swap_propn"</span>=<span class="dv">1</span>),
                  <span class="dt">filename =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chain_path_real,x), 
                  <span class="dt">CREATE_POSTERIOR_FUNC =</span> create_posterior_func, 
                  <span class="dt">version =</span> prior_version)
}</code></pre></div>
</div>
<div id="post-run-analyses" class="section level1">
<h1 class="hasAnchor">
<a href="#post-run-analyses" class="anchor"></a>Post-run analyses</h1>
<p>Once the MCMC chains are run, <code>serosolver</code> provides a number of simple functions to generate standard outputs and MCMC diagnostics. The saved MCMC chains are compatible with the <code>coda</code> and <code>bayesplot</code> packages, and users are encouraged to use these. First, read in the MCMC chains. The below function distinguishes between posterior samples for the infection history matrix and for the process parameters. The function searches for all files with the filenames generated by <code>run_MCMC</code> in the specified directory, and returns data structures with these concatenated and separated in a list.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Read in the MCMC chains
<span class="co"># Note that `thin` here is in addition to any thinning done during the fitting</span>
<span class="co"># Chain length values in load function need to be consistent with MCMC run</span>
all_chains &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_mcmc_chains.html">load_mcmc_chains</a></span>(<span class="dt">location=</span>chain_path_real,<span class="dt">thin=</span><span class="dv">1</span>,<span class="dt">burnin=</span><span class="dv">100000</span>,
                             <span class="dt">par_tab=</span>par_tab,<span class="dt">unfixed=</span><span class="ot">FALSE</span>,<span class="dt">convert_mcmc=</span><span class="ot">TRUE</span>)
<span class="co">#&gt; Chains detected:     5Highest MCMC sample interations: </span>
<span class="co">#&gt; Chains detected: </span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_1_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_2_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_3_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_4_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_5_infection_histories.csv</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 77802</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 77654</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 77607</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] 77540</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; [1] 77581</span>
## Alternative, load the included MCMC chains rather than re-running
## load(cs1_chains_real)
## all_chains &lt;- cs1_chains_real

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(all_chains))
<span class="co">#&gt;                   Length Class      Mode   </span>
<span class="co">#&gt; theta_chain       65130  mcmc       numeric</span>
<span class="co">#&gt; inf_chain             5  data.table list   </span>
<span class="co">#&gt; theta_list_chains     5  -none-     list   </span>
<span class="co">#&gt; inf_list_chains       5  -none-     list</span></code></pre></div>
<p>Chains should then be checked for the usual MCMC diagnostics: <span class="math inline">\(\hat{R}\)</span> and effective sample size. First, looking at the antibody kinetics process parameters:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Get the MCMC chains as a list
list_chains &lt;-<span class="st"> </span>all_chains<span class="op">$</span>theta_list_chains
## Look at diagnostics for the free parameters
list_chains1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(list_chains, <span class="cf">function</span>(x) x[,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu_short"</span>,<span class="st">"wane"</span>,<span class="st">"error"</span>,
                                                     <span class="st">"total_infections"</span>,
                                                     <span class="st">"lnlike"</span>,<span class="st">"prior_prob"</span>)])

## Gelman-Rubin diagnostics to assess between-chain convergence for each parameter
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/gelman.diag">gelman.diag</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/mcmc.list">as.mcmc.list</a></span>(list_chains1)))
<span class="co">#&gt; Potential scale reduction factors:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  Point est. Upper C.I.</span>
<span class="co">#&gt; mu_short               1.00       1.00</span>
<span class="co">#&gt; wane                   1.00       1.00</span>
<span class="co">#&gt; error                  1.00       1.00</span>
<span class="co">#&gt; total_infections       1.00       1.01</span>
<span class="co">#&gt; lnlike                 1.00       1.01</span>
<span class="co">#&gt; prior_prob             1.01       1.01</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Multivariate psrf</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 1.01</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/gelman.plot">gelman.plot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/mcmc.list">as.mcmc.list</a></span>(list_chains1))</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## Effective sample size for each parameter
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/effectiveSize">effectiveSize</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/mcmc.list">as.mcmc.list</a></span>(list_chains1)))
<span class="co">#&gt;         mu_short             wane            error total_infections </span>
<span class="co">#&gt;         1188.645         1516.289         2178.818         1796.869 </span>
<span class="co">#&gt;           lnlike       prior_prob </span>
<span class="co">#&gt;         1032.867         1058.834</span>

## Posterior estimates for each parameter
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/mcmc.list">as.mcmc.list</a></span>(list_chains1)))
<span class="co">#&gt; </span>
<span class="co">#&gt; Iterations = 1:501</span>
<span class="co">#&gt; Thinning interval = 1 </span>
<span class="co">#&gt; Number of chains = 5 </span>
<span class="co">#&gt; Sample size per chain = 501 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 1. Empirical mean and standard deviation for each variable,</span>
<span class="co">#&gt;    plus standard error of the mean:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                        Mean        SD  Naive SE Time-series SE</span>
<span class="co">#&gt; mu_short          4.030e+00  0.096709 1.932e-03      0.0028388</span>
<span class="co">#&gt; wane              2.814e-02  0.004248 8.488e-05      0.0001122</span>
<span class="co">#&gt; error             7.888e-01  0.028083 5.611e-04      0.0006070</span>
<span class="co">#&gt; total_infections  1.550e+02  2.352663 4.701e-02      0.0558343</span>
<span class="co">#&gt; lnlike           -1.218e+03  9.612929 1.921e-01      0.3079579</span>
<span class="co">#&gt; prior_prob       -6.466e+02 11.010436 2.200e-01      0.3480271</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 2. Quantiles for each variable:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                        2.5%        25%        50%        75%      97.5%</span>
<span class="co">#&gt; mu_short          3.847e+00  3.963e+00  4.030e+00  4.098e+00  4.220e+00</span>
<span class="co">#&gt; wane              1.999e-02  2.539e-02  2.811e-02  3.087e-02  3.627e-02</span>
<span class="co">#&gt; error             7.373e-01  7.695e-01  7.880e-01  8.068e-01  8.481e-01</span>
<span class="co">#&gt; total_infections  1.500e+02  1.530e+02  1.550e+02  1.570e+02  1.590e+02</span>
<span class="co">#&gt; lnlike           -1.237e+03 -1.225e+03 -1.218e+03 -1.212e+03 -1.199e+03</span>
<span class="co">#&gt; prior_prob       -6.660e+02 -6.544e+02 -6.473e+02 -6.395e+02 -6.232e+02</span>


## Plot the MCMC trace using the `bayesplot` package
<span class="kw"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"viridis"</span>)
p_theta_trace &lt;-<span class="st"> </span><span class="kw"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html">mcmc_trace</a></span>(list_chains1)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_theta_trace)</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-6-2.png" width="768"></p>
<p>and at the infection histories:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Extract infection history chain
inf_chain &lt;-<span class="st"> </span>all_chains<span class="op">$</span>inf_chain

## Look at inferred attack rates
p_ar &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_attack_rates.html">plot_attack_rates</a></span>(inf_chain, titre_dat, strain_isolation_times, <span class="dt">pad_chain=</span><span class="ot">FALSE</span>,
                          <span class="dt">plot_den =</span> <span class="ot">TRUE</span>,<span class="dt">prior_pars=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">prior_version=</span>prior_version, 
                                                          <span class="dt">alpha=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"alpha"</span>,<span class="st">"values"</span>],
                                                          <span class="dt">beta=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"beta"</span>,<span class="st">"values"</span>])) 
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_ar)</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## Calculate convergence diagnostics and summary statistics on infection histories
## Important to scale all infection estimates by number alive from titre_dat
n_alive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_n_alive_group.html">get_n_alive_group</a></span>(titre_dat, strain_isolation_times,<span class="dt">melt=</span><span class="ot">TRUE</span>)

## This function generates a number of MCMC outputs
ps_infhist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_posteriors_infhist.html">plot_posteriors_infhist</a></span>(<span class="dt">inf_chain=</span>inf_chain, 
                                      <span class="dt">years=</span>strain_isolation_times, 
                                      <span class="dt">samples =</span> <span class="dv">100</span>,  <span class="co"># Needs to be smaller than length of sampled chain </span>
                                      <span class="dt">n_alive=</span>n_alive)
<span class="co">#&gt; Calculating by time summaries...</span>
<span class="co">#&gt; Done</span>
<span class="co">#&gt; Calculating by individual summaries...</span>
<span class="co">#&gt; Done</span>


## Posterior mean, median, 95% credible intervals and effective sample size
## on per time attack rates
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(ps_infhist[[<span class="st">"estimates"</span>]]<span class="op">$</span>by_year))
<span class="co">#&gt; Empty data.table (0 rows and 7 cols): j,group,mean,median,lower_quantile,upper_quantile...</span>

## Posterior mean, median, 95% credible intervals and effective sample size
## on per individual total number of infections
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(ps_infhist[[<span class="st">"estimates"</span>]]<span class="op">$</span>by_indiv))
<span class="co">#&gt;    i     mean median lower_quantile upper_quantile effective_size</span>
<span class="co">#&gt; 1: 1 2.000000      2              2              2          0.000</span>
<span class="co">#&gt; 2: 2 1.998004      2              2              2       2505.000</span>
<span class="co">#&gt; 3: 3 2.000000      2              2              2          0.000</span>
<span class="co">#&gt; 4: 4 1.962475      2              1              2       2082.897</span>
<span class="co">#&gt; 5: 6 1.001996      1              1              1       2505.000</span>
<span class="co">#&gt; 6: 7 1.908982      2              1              2       2312.508</span>

## Check for agreement between inferred cumulative infection histories 
## for some individuals
p_indiv_inf_hists &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_cumulative_inf_plots.html">generate_cumulative_inf_plots</a></span>(inf_chain, <span class="dt">indivs=</span><span class="dv">1</span><span class="op">:</span><span class="dv">9</span>, <span class="dt">pad_chain=</span><span class="ot">FALSE</span>,
                                                   <span class="dt">nsamp =</span> <span class="dv">100</span>, <span class="co"># Needs to be smaller than length of sampled chain </span>
                                                   <span class="dt">strain_isolation_times =</span> strain_isolation_times,
                                                   <span class="dt">number_col=</span><span class="dv">3</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_indiv_inf_hists[[<span class="dv">1</span>]])</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-7-2.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## Posterior probability that infections occured at given times per individual
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_indiv_inf_hists[[<span class="dv">2</span>]])</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-7-3.png" width="672"></p>
<p>Users may also easily check the inferred antibody landscapes at the time each sample was taken. Black dots show observations, shaded regions and black line show 95%, 50% credible intervals and posterior median.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## get_titre_predictions expects only a single MCMC chain, so
## subset for only one chain
chain &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(all_chains<span class="op">$</span>theta_chain)
chain1 &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,]
inf_chain1 &lt;-<span class="st"> </span>inf_chain[inf_chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,]

titre_preds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_titre_predictions.html">get_titre_predictions</a></span>(<span class="dt">chain =</span> chain1, 
                                     <span class="dt">infection_histories =</span> inf_chain1, 
                                     <span class="dt">titre_dat =</span> titre_dat, 
                                     <span class="dt">individuals =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(titre_dat<span class="op">$</span>individual),
                                     <span class="dt">nsamp =</span> <span class="dv">100</span>, <span class="co"># Needs to be smaller than length of sampled chain </span>
                                     <span class="dt">antigenic_map =</span> antigenic_map, 
                                     <span class="dt">par_tab =</span> par_tab,<span class="dt">expand_titredat=</span><span class="ot">FALSE</span>)
<span class="co">#&gt; Creating model solving function...</span>
<span class="co">#&gt; </span>
to_use &lt;-<span class="st"> </span>titre_preds<span class="op">$</span>predictions
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(to_use))
<span class="co">#&gt;   individual virus titre samples  DOB run group    lower lower_50   median</span>
<span class="co">#&gt; 1          1  8037     0    8039 8036   1     1 0.000000 0.000000 0.000000</span>
<span class="co">#&gt; 2          1  8037     0    8040 8036   1     1 0.000000 0.000000 0.000000</span>
<span class="co">#&gt; 3          1  8037     7    8044 8036   1     1 7.340042 7.508257 7.608256</span>
<span class="co">#&gt; 4          1  8037     7    8047 8036   1     1 6.698128 6.833544 6.943332</span>
<span class="co">#&gt; 5          2  8037     0    8039 8036   1     1 0.000000 0.000000 0.000000</span>
<span class="co">#&gt; 6          2  8037     5    8041 8036   1     1 3.778014 3.889202 3.946000</span>
<span class="co">#&gt;   upper_50    upper      max</span>
<span class="co">#&gt; 1 0.000000 0.000000 0.000000</span>
<span class="co">#&gt; 2 0.000000 0.000000 0.000000</span>
<span class="co">#&gt; 3 7.730782 8.056171 7.626037</span>
<span class="co">#&gt; 4 7.068453 7.309048 6.996487</span>
<span class="co">#&gt; 5 0.000000 0.000000 0.000000</span>
<span class="co">#&gt; 6 4.035576 7.691041 3.865481</span>

## Using ggplot
titre_pred_p &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(to_use[to_use<span class="op">$</span>individual <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>,<span class="dv">13</span>),])<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>samples,<span class="dt">ymin=</span>lower, <span class="dt">ymax=</span>upper),<span class="dt">fill=</span><span class="st">"gray90"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>samples,<span class="dt">ymin=</span>lower_<span class="dv">50</span>, <span class="dt">ymax=</span>upper_<span class="dv">50</span>),<span class="dt">fill=</span><span class="st">"gray70"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>samples, <span class="dt">y=</span>median))<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>samples, <span class="dt">y=</span>titre))<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span>(<span class="dt">ylim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>,<span class="dv">8</span>))<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"log titre"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Time of virus circulation"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>individual)
titre_pred_p</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div id="simulation-recovery" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation-recovery" class="anchor"></a>Simulation recovery</h1>
<p>We finish the vignette by presenting a simulation-recovery experiment to test the ability of the framework to recover known infection histories and antibody kinetics parameters using simulated data that matches the real dataset.</p>
<div id="extract-attack-rates-from-fits" class="section level2">
<h2 class="hasAnchor">
<a href="#extract-attack-rates-from-fits" class="anchor"></a>Extract attack rates from fits</h2>
<p>We simulate infection histories and antibody titre data based on the “real” parameters inferred from fitting the model above. First, we extract the maximum posterior probability antibody kinetics parameters and attack rates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Read in MCMC chains from fitting
all_chains &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_mcmc_chains.html">load_mcmc_chains</a></span>(<span class="dt">location=</span>chain_path_real,<span class="dt">thin=</span><span class="dv">1</span>,<span class="dt">burnin=</span><span class="dv">100000</span>,
                               <span class="dt">par_tab=</span>par_tab,<span class="dt">unfixed=</span><span class="ot">FALSE</span>,<span class="dt">convert_mcmc=</span><span class="ot">FALSE</span>)
<span class="co">#&gt; Chains detected:     5Highest MCMC sample interations: </span>
<span class="co">#&gt; Chains detected: </span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_1_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_2_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_3_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_4_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_real//case_study_1_5_infection_histories.csv</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 77802</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 77654</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 77607</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] 77540</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; [1] 77581</span>

## Alternative, load the included MCMC chains rather than re-running
## load(cs1_chains_real_b)
## all_chains &lt;- cs1_chains_real_b

## Find samples that were in both theta and inf hist chains
chain &lt;-<span class="st"> </span>all_chains<span class="op">$</span>theta_chain
inf_chain &lt;-<span class="st"> </span>all_chains<span class="op">$</span>inf_chain
intersect_samps &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/setops">intersect</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(inf_chain<span class="op">$</span>sampno), <span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(chain<span class="op">$</span>sampno))
chain &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>sampno <span class="op">%in%</span><span class="st"> </span>intersect_samps,]

## Find the parameter values that gave the highest posterior probability
which_mle &lt;-<span class="st"> </span>chain[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which.min">which.max</a></span>(chain<span class="op">$</span>lnlike),<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sampno"</span>,<span class="st">"chain_no"</span>)]
mle_theta_pars &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>sampno <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>sampno <span class="op">&amp;</span><span class="st"> </span>chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>chain_no,]

## Store total infections to compare later
mle_total_infs &lt;-<span class="st"> </span>mle_theta_pars[,<span class="st">"total_infections"</span>]
mle_theta_pars &lt;-<span class="st"> </span>mle_theta_pars[,par_tab<span class="op">$</span>names]
mle_inf_hist &lt;-<span class="st"> </span>inf_chain[inf_chain<span class="op">$</span>sampno <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>sampno <span class="op">&amp;</span><span class="st"> </span>inf_chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>chain_no,]

## Generate full infection history matrix using provided function
mle_inf_hist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_summary_inf_chain.html">expand_summary_inf_chain</a></span>(mle_inf_hist[,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sampno"</span>,<span class="st">"j"</span>,<span class="st">"i"</span>,<span class="st">"x"</span>)])
## Find number of infections per year from this infection history
no_infs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(mle_inf_hist[,<span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(mle_inf_hist)])

## If missing time points in simulated attack rates
<span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(no_infs) <span class="op">&lt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(strain_isolation_times)){
  diff_lengths &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(strain_isolation_times) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(no_infs)
  no_infs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(no_infs, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, diff_lengths))
}

## Find attack rate per year
n_alive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_n_alive.html">get_n_alive</a></span>(titre_dat, strain_isolation_times)
attack_rates &lt;-<span class="st"> </span>no_infs<span class="op">/</span>n_alive</code></pre></div>
<p>Functions are provided to simulate antibody titre data under a given serosurvey design. The antibody kinetics parameters and attack rates estimated above are used to simulate titres from the model. The <code>simulate_data</code> function is well documented, and users should refer to the help file to customise the simulated serosurvey design.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1234</span>)

sim_par_tab &lt;-<span class="st"> </span>par_tab
sim_par_tab<span class="op">$</span>values &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(mle_theta_pars)
sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>),<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)
sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "wane"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">1</span>
sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "wane"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span>par_tab[par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "wane"</span>,<span class="st">"values"</span>]<span class="op">/</span>resolution
sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>,<span class="st">"tau"</span>,<span class="st">"sigma1"</span>,<span class="st">"sigma2"</span>),<span class="st">"fixed"</span>] &lt;-<span class="st"> </span><span class="dv">1</span> 
sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu"</span>,<span class="st">"tau"</span>,<span class="st">"sigma1"</span>,<span class="st">"sigma2"</span>),<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">0</span> 
sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "MAX_TITRE"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">9</span> 

sampling_times &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">2009</span><span class="op">*</span>resolution <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">2012</span><span class="op">*</span>resolution, <span class="dt">by=</span><span class="dv">1</span>)

age_min &lt;-<span class="st"> </span><span class="dv">6</span><span class="op">*</span>resolution
age_max &lt;-<span class="st"> </span><span class="dv">6</span><span class="op">*</span>resolution
n_indiv &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(titre_dat<span class="op">$</span>individual))

dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simulate_data.html">simulate_data</a></span>(<span class="dt">par_tab =</span> sim_par_tab, 
                     <span class="dt">n_indiv =</span> n_indiv,
                     <span class="dt">buckets =</span> resolution,
                     <span class="dt">strain_isolation_times =</span> strain_isolation_times,
                     <span class="dt">sampling_times =</span> sampling_times, 
                     <span class="dt">nsamps =</span> <span class="dv">4</span>, 
                     <span class="dt">antigenic_map =</span> antigenic_map, 
                     <span class="dt">age_min =</span> age_min,
                     <span class="dt">age_max =</span> age_max,
                     <span class="dt">attack_rates=</span>attack_rates,
                     <span class="dt">repeats =</span> <span class="dv">1</span>)
<span class="co">#&gt; Simulating data</span>



## Inspect simulated antibody titre data and infection histories
sim_titre_dat &lt;-<span class="st"> </span>dat[[<span class="st">"data"</span>]]
sim_infection_histories &lt;-<span class="st"> </span>dat[[<span class="st">"infection_histories"</span>]]

## Store total infections to compare later
actual_total_infections &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(sim_infection_histories)

<span class="kw"><a href="../reference/plot_data.html">plot_data</a></span>(sim_titre_dat, sim_infection_histories, strain_isolation_times,<span class="dt">n_samps =</span> <span class="dv">5</span>)</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## Use titres only against same viruses tested in real data
viruses &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(titre_dat<span class="op">$</span>virus)
sim_titre_dat &lt;-<span class="st"> </span>sim_titre_dat[sim_titre_dat<span class="op">$</span>virus <span class="op">%in%</span><span class="st"> </span>viruses, ]
sim_ages &lt;-<span class="st"> </span>dat[[<span class="st">"ages"</span>]]
sim_titre_dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(sim_titre_dat, sim_ages)
sim_ar &lt;-<span class="st"> </span>dat[[<span class="st">"attack_rates"</span>]]</code></pre></div>
</div>
<div id="simulation-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-fitting" class="anchor"></a>Simulation fitting</h2>
<p>Once these simulated data have been generated, the work flow becomes exactly the same as with the real data above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">filename &lt;-<span class="st"> "case_study_1_sim"</span>

## Distinct filename for each chain
no_chains &lt;-<span class="st"> </span><span class="dv">5</span>
filenames &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(filename, <span class="st">"_"</span>,<span class="dv">1</span><span class="op">:</span>no_chains)

## Create the posterior solving function that will be used in the MCMC framework 
model_func &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_posterior_func.html">create_posterior_func</a></span>(<span class="dt">par_tab=</span>sim_par_tab,
                                <span class="dt">titre_dat=</span>sim_titre_dat,
                                <span class="dt">antigenic_map=</span>antigenic_map,
                                <span class="dt">version=</span><span class="dv">2</span>) <span class="co"># function in posteriors.R</span>
<span class="co">#&gt; Creating posterior solving function...</span>
<span class="co">#&gt; </span>

## Generate results in parallel
res &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/foreach/topics/foreach">foreach</a></span>(<span class="dt">x =</span> filenames, <span class="dt">.packages =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'serosolver'</span>,<span class="st">'data.table'</span>,<span class="st">'plyr'</span>)) <span class="op">%dopar%</span><span class="st"> </span>{
  ## Not all random starting conditions return finite likelihood, so for each chain generate random
  ## conditions until we get one with a finite likelihood
  start_prob &lt;-<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span>
  <span class="cf">while</span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/is.finite">is.finite</a></span>(start_prob)){
    ## Generate starting values for theta
    start_tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_start_tab.html">generate_start_tab</a></span>(par_tab)
    ## Generate starting infection history
    start_inf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/setup_infection_histories_new_2.html">setup_infection_histories_new_2</a></span>(sim_titre_dat, strain_isolation_times, <span class="dt">space=</span><span class="dv">3</span>,<span class="dt">titre_cutoff=</span><span class="dv">4</span>)
    start_prob &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw">model_func</span>(start_tab<span class="op">$</span>values, start_inf)[[<span class="dv">1</span>]])
  }
  
  res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_MCMC.html">run_MCMC</a></span>(<span class="dt">par_tab =</span> start_tab, 
                  <span class="dt">titre_dat =</span> sim_titre_dat,
                  <span class="dt">antigenic_map =</span> antigenic_map,
                  <span class="dt">start_inf_hist =</span> start_inf, 
                  <span class="dt">mcmc_pars =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"iterations"</span>=<span class="dv">500000</span>,<span class="st">"adaptive_period"</span>=<span class="dv">100000</span>,<span class="st">"thin"</span>=<span class="dv">1000</span>,
                                <span class="st">"thin_hist"</span>=<span class="dv">1000</span>,<span class="st">"save_block"</span>=<span class="dv">1000</span>,
                                <span class="st">"hist_switch_prob"</span>=<span class="fl">0.8</span>, <span class="st">"hist_sample_prob"</span>=<span class="dv">1</span>),
                  <span class="dt">filename =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chain_path_sim,x), 
                  <span class="dt">CREATE_POSTERIOR_FUNC =</span> create_posterior_func, 
                  <span class="dt">version =</span> prior_version)
}</code></pre></div>
</div>
<div id="simulation-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-analysis" class="anchor"></a>Simulation analysis</h2>
<p>MCMC chains should be checked for convergence under the usual diagnostics. We also compare the inferred posterior distributions to the known true parameter values. We see that convergence and between-chain agreement is good and that the model recovers reasonably unbiased estimates for some parameters. However, under this sampling strategy the model slightly underestimates the amount of long term antibody boosting elicited by a single infection and overestimates the total number of infections. This is driven by the contribution of the attack rate prior relative to the contribution of the likelihood (the data). Increasing the number of measured titres (for example, measure titres against 40 viruses rather than 9) or using a more informative attack rate prior would help reduce this bias.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Read in the MCMC chains
## Note that `thin` here is in addition to any thinning done during the fitting
sim_all_chains &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_mcmc_chains.html">load_mcmc_chains</a></span>(<span class="dt">location=</span>chain_path_sim,<span class="dt">thin=</span><span class="dv">1</span>,<span class="dt">burnin=</span><span class="dv">100000</span>,
                                   <span class="dt">par_tab=</span>par_tab,<span class="dt">unfixed=</span><span class="ot">FALSE</span>,<span class="dt">convert_mcmc=</span><span class="ot">TRUE</span>)
<span class="co">#&gt; Chains detected:     5Highest MCMC sample interations: </span>
<span class="co">#&gt; Chains detected: </span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_sim//case_study_1_sim_1_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_sim//case_study_1_sim_2_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_sim//case_study_1_sim_3_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_sim//case_study_1_sim_4_infection_histories.csv</span>
<span class="co">#&gt; /home/james/R/x86_64-pc-linux-gnu-library/3.6/serosolver/extdata/cs1_sim//case_study_1_sim_5_infection_histories.csv</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 64087</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 64078</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 64117</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] 63991</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; [1] 64055</span>

## Alternative, load the included MCMC chains rather than re-running
## load(cs1_chains_sim)
## sim_all_chains &lt;- cs1_chains_sim

theta_chain &lt;-<span class="st"> </span>sim_all_chains<span class="op">$</span>theta_chain
## Get the MCMC chains as a list
list_chains &lt;-<span class="st"> </span>sim_all_chains<span class="op">$</span>theta_list_chains
## Look at diagnostics for the free parameters
list_chains1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(list_chains, <span class="cf">function</span>(x) x[,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mu_short"</span>,<span class="st">"wane"</span>,<span class="st">"error"</span>,
                                                     <span class="st">"total_infections"</span>,
                                                     <span class="st">"lnlike"</span>,<span class="st">"prior_prob"</span>)])

## Gelman-Rubin diagnostics and effective sample size
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/gelman.diag">gelman.diag</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/mcmc.list">as.mcmc.list</a></span>(list_chains1)))
<span class="co">#&gt; Potential scale reduction factors:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  Point est. Upper C.I.</span>
<span class="co">#&gt; mu_short              0.999      0.999</span>
<span class="co">#&gt; wane                  1.001      1.003</span>
<span class="co">#&gt; error                 1.007      1.022</span>
<span class="co">#&gt; total_infections      1.002      1.008</span>
<span class="co">#&gt; lnlike                1.003      1.007</span>
<span class="co">#&gt; prior_prob            1.004      1.012</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Multivariate psrf</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 1.01</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/effectiveSize">effectiveSize</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/coda/topics/mcmc.list">as.mcmc.list</a></span>(list_chains1)))
<span class="co">#&gt;         mu_short             wane            error total_infections </span>
<span class="co">#&gt;        2400.1066        2351.8075        2435.3069        2344.9755 </span>
<span class="co">#&gt;           lnlike       prior_prob </span>
<span class="co">#&gt;         976.3142         914.5369</span>

melted_theta_chain &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/reshape2/topics/melt">melt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(theta_chain), <span class="dt">id.vars=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"sampno"</span>,<span class="st">"chain_no"</span>))
estimated_pars &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(sim_par_tab[sim_par_tab<span class="op">$</span>fixed <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,<span class="st">"names"</span>],<span class="st">"total_infections"</span>)
melted_theta_chain &lt;-<span class="st"> </span>melted_theta_chain[melted_theta_chain<span class="op">$</span>variable <span class="op">%in%</span><span class="st"> </span>estimated_pars,]
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(melted_theta_chain)[<span class="dv">3</span>] &lt;-<span class="st"> "names"</span>

add_row &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="st">"total_infections"</span>,actual_total_infections,<span class="dv">0</span>,<span class="fl">0.1</span>,<span class="dv">0</span>,<span class="dv">10000</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(add_row) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(sim_par_tab)
sim_par_tab1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/rbindlist">rbind</a></span>(sim_par_tab, add_row)

<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(melted_theta_chain) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>value,<span class="dt">fill=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(chain_no)),<span class="dt">alpha=</span><span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="dt">data=</span>sim_par_tab1[sim_par_tab1<span class="op">$</span>fixed <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,],<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">xintercept=</span>values),<span class="dt">linetype=</span><span class="st">"dashed"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>names,<span class="dt">scales=</span><span class="st">"free"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position=</span><span class="st">"bottom"</span>)</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
<p>Recovery of known attack rates is also reasonably accurate, though the constraint of the posterior distibution is quite low for many years where identifiability is poor. Again, more titre data or more individuals would improve inferential power. One particularly reassuring plot is the comparison of known individual cumulative infection histories (the cumulative sum of infections over time for an individual) against the estimated posterior distribution of cumulative infection histories. We see that the 95% credible intervals capture the true cumulative infection histories in almost all cases.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Extract infection history chain
inf_chain &lt;-<span class="st"> </span>sim_all_chains<span class="op">$</span>inf_chain

## Look at inferred attack rates
p_ar &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_attack_rates.html">plot_attack_rates</a></span>(inf_chain, sim_titre_dat, strain_isolation_times, <span class="dt">pad_chain=</span><span class="ot">FALSE</span>,
                            <span class="dt">plot_den =</span> <span class="ot">TRUE</span>,<span class="dt">prior_pars=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">prior_version=</span>prior_version, 
                                                          <span class="dt">alpha=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"alpha"</span>,<span class="st">"values"</span>],
                                                          <span class="dt">beta=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"beta"</span>,<span class="st">"values"</span>]))  <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="dt">data=</span>sim_ar,<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>year,<span class="dt">y=</span>AR),<span class="dt">col=</span><span class="st">"purple"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_ar)</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## Calculate convergence diagnostics and summary statistics on infection histories
## Important to scale all infection estimates by number alive from titre_dat
sim_n_alive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_n_alive_group.html">get_n_alive_group</a></span>(sim_titre_dat, strain_isolation_times,<span class="dt">melt=</span><span class="ot">TRUE</span>)

## This function generates a number of MCMC outputs
ps_infhist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_posteriors_infhist.html">plot_posteriors_infhist</a></span>(<span class="dt">inf_chain=</span>inf_chain, 
                                      <span class="dt">years=</span>strain_isolation_times, 
                                      <span class="dt">n_alive=</span>sim_n_alive)
<span class="co">#&gt; Calculating by time summaries...</span>
<span class="co">#&gt; Done</span>
<span class="co">#&gt; Calculating by individual summaries...</span>
<span class="co">#&gt; Done</span>

## Check for agreement between inferred cumulative infection histories 
## for some individuals
p_indiv_inf_hists &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_cumulative_inf_plots.html">generate_cumulative_inf_plots</a></span>(inf_chain,<span class="dt">indivs=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">12</span>,<span class="dv">21</span>,<span class="dv">39</span>,<span class="dv">41</span>,<span class="dv">44</span>,<span class="dv">66</span>,<span class="dv">71</span>,<span class="dv">76</span>,<span class="dv">79</span>),<span class="dt">pad_chain=</span><span class="ot">FALSE</span>,
                                                   <span class="dt">real_inf_hist=</span>sim_infection_histories,
                                                  <span class="dt">strain_isolation_times =</span> strain_isolation_times,
                                                  <span class="dt">number_col=</span><span class="dv">3</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_indiv_inf_hists[[<span class="dv">1</span>]])</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-12-2.png" width="768"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Posterior probability that infections occured at given times per individual
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(p_indiv_inf_hists[[<span class="dv">2</span>]])</code></pre></div>
<p><img src="cs1_vignette_files/figure-html/unnamed-chunk-12-3.png" width="768"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li>
<a href="#setup">Setup</a><ul class="nav nav-pills nav-stacked">
<li><a href="#installation-and-requirements">Installation and requirements</a></li>
      <li><a href="#assumptions">Assumptions</a></li>
      <li><a href="#preparing-the-data">Preparing the data</a></li>
      <li><a href="#summary">Summary</a></li>
      </ul>
</li>
      <li><a href="#running-the-mcmc">Running the MCMC</a></li>
      <li><a href="#post-run-analyses">Post-run analyses</a></li>
      <li>
<a href="#simulation-recovery">Simulation recovery</a><ul class="nav nav-pills nav-stacked">
<li><a href="#extract-attack-rates-from-fits">Extract attack rates from fits</a></li>
      <li><a href="#simulation-fitting">Simulation fitting</a></li>
      <li><a href="#simulation-analysis">Simulation analysis</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by James Hay, Adam Kucharski, Kylie Ainslie, Amanda Minter, Steven Riley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
